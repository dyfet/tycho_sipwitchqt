Name: sipwitchqt
Version: ${PROJECT_VERSION}
Release: 1
Summary: Sip server system daemon

License: GPLv3+
URL:     https://gitlab.com/tychosoft/sipwitchqt
Source0: https:///pub.cherokeesofidaho.org/tarballs/%{name}-%{version}.tar.gz
Group:	 system/telephony

BuildRequires: cmake >= 3.1.0
BuildRequires: libqt5-qtbase-devel, libqt5-linguist-devel, gcc-c++
BuildRequires: libosip2-devel, libeXosip2-devel >= 4.0.0
BuildRequires: gperftools-devel, systemd-devel

%package server
Recommends: libQt5Sql5-mysql, libQt5Sql5-sqlite
Summary: sipwitchqt server

%package utils
Recommends: sipwitchqt-server, ruby-sqlite3
Requires: ruby
Summary: sipwitchqt utility scripts and commands

%package desktop
Summary: sipwitchqt desktop client 

%description
A pbx server and desktop client for the sip protocol

%description server
A pbx server for the sip protocol

%description utils
Extra utility commands and scripts to use with sipwitchqt.  Some may be used stand-alone.
This includes sqlite3 local db administration support for SipWitchQt. 

%description desktop
SipWitchQt desktop client.

%prep
%setup -q

%build
%cmake  -DCMAKE_INSTALL_SYSCONFDIR=%{_sysconfdir} \
        -DCMAKE_INSTALL_LOCALSTATEDIR=%{_localstatedir}

%{__make} %{?_smp_mflags}

%install
%cmake_install

%post
/sbin/chkconfig --add sipwitchqt

%preun
if [ "$1" = 0 ]; then
	/sbin/service sipwitchqt stop >/dev/null 2>&1
	/sbin/chkconfig --del sipwitchqt
fi	 
exit 0

%postun
if [ "$1" -ge 1 ] ; then
	/sbin/service sipwitchqt condrestart >/dev/null 2>&1
fi
exit 0

%files server
%defattr(-,root,root)
%doc README.md DOCKER.md CONTRIBUTING.md LICENSE CHANGELOG
%{_sbindir}/sipwitchqt-server
%{_sysconfdir}/sv/sipwitchqt/run
%attr(0664,root,root) %config(noreplace) %{_sysconfdir}/sipwitchqt.conf
%attr(0664,root,root) %{_libdir}/systemd/system/sipwitchd.service

%files utils
%defattr(-,root,root)
%{_sbindir}/swcert-*
%{_mandir}/man1/swcert-*
%{_sbindir}/swlite-*
%{_mandir}/man1/swlite-*

%files desktop
%defattr(-,root,root)
%{_bindir}/sipwitchqt-desktop
%{_datadir}/applications/sipwitchqt.desktop
%{_datadir}/appdata/sipwitchqt.appdata.xml
%{_datadir}/pixmaps/sipwitchqt.png

